name: Release

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types:
      - completed

permissions:
  contents: write

# Prevent parallel release runs - serialize by commit SHA
# First run wins, subsequent runs wait and can skip if release exists
concurrency:
  group: release-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run if CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get tag name if present
        id: get_tag
        run: |
          # Check if the commit has a tag
          TAG=$(git describe --tags --exact-match ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "")
          if [ -n "$TAG" ]; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if release already published
        if: steps.get_tag.outputs.is_tag == 'true'
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.get_tag.outputs.tag }}
        run: |
          # Check if release exists AND has assets (meaning another run already published)
          ASSET_COUNT=$(gh release view "$TAG" --json assets -q '.assets | length' 2>/dev/null || echo "0")
          if [ "$ASSET_COUNT" -gt "0" ]; then
            echo "‚úÖ Release $TAG already published with $ASSET_COUNT assets - skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG not yet published or has no assets - proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify tag is on main branch
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        run: |
          TAG_SHA=${{ github.event.workflow_run.head_sha }}
          
          # Check if this commit exists on main branch
          if ! git branch -r --contains "$TAG_SHA" | grep -q "origin/main"; then
            echo "::error::Tag must be created from main branch. This tag points to a commit not on main."
            echo "Tagged commit: $TAG_SHA"
            echo "Branches containing this commit:"
            git branch -r --contains "$TAG_SHA"
            exit 1
          fi
          
          echo "‚úÖ Tag verified: commit $TAG_SHA is on main branch"

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Delete previous dev release
        if: steps.get_tag.outputs.is_tag != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete dev --yes --cleanup-tag 2>/dev/null || true

      - name: Preserve manual release notes
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        id: prev_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.get_tag.outputs.tag }}
        run: |
          # Save any manually-written release notes before GoReleaser replaces them.
          # These may have been added via GitHub UI before CI ran.
          PREV_BODY=$(gh release view "$TAG" --json body -q '.body' 2>/dev/null || echo "")
          if [ -n "$PREV_BODY" ]; then
            echo "üìù Found existing release notes for $TAG ‚Äî preserving"
            echo "$PREV_BODY" > /tmp/prev_notes.md
            echo "has_prev=true" >> $GITHUB_OUTPUT
          else
            echo "No existing release notes to preserve"
            echo "has_prev=false" >> $GITHUB_OUTPUT
          fi

      - name: Run GoReleaser (tagged release)
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ steps.get_tag.outputs.tag }}

      - name: Merge preserved notes into release
        if: steps.get_tag.outputs.is_tag == 'true' && steps.prev_notes.outputs.has_prev == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.get_tag.outputs.tag }}
        run: |
          # Append the previously-written manual notes below the GoReleaser output
          CURRENT_BODY=$(gh release view "$TAG" --json body -q '.body' 2>/dev/null || echo "")
          PREV_BODY=$(cat /tmp/prev_notes.md)
          MERGED=$(printf '%s\n\n---\n\n### Previous Release Notes\n\n%s' "$CURRENT_BODY" "$PREV_BODY")
          gh release edit "$TAG" --notes "$MERGED"
          echo "‚úÖ Merged preserved release notes into $TAG"

      - name: Check for tag on commit (dev build guard)
        if: steps.get_tag.outputs.is_tag != 'true'
        id: dev_guard
        run: |
          # Double-check: skip dev build if ANY version tag exists on this commit
          # Handles race condition where tag push event arrives after branch push
          ALL_TAGS=$(git tag --points-at ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "")
          if echo "$ALL_TAGS" | grep -qE '^v[0-9]'; then
            echo "‚è≠Ô∏è Commit has version tag(s): $ALL_TAGS ‚Äî skipping dev build"
            echo "skip_dev=true" >> $GITHUB_OUTPUT
          else
            echo "No version tags found ‚Äî proceeding with dev build"
            echo "skip_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Run GoReleaser (dev release)
        if: steps.get_tag.outputs.is_tag != 'true' && steps.dev_guard.outputs.skip_dev != 'true'
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dev release
        if: steps.get_tag.outputs.is_tag != 'true' && steps.dev_guard.outputs.skip_dev != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create dev \
            --title "Development Build (latest)" \
            --notes "‚ö†Ô∏è **Automated development build from main branch**

          **Commit:** \`${{ github.event.workflow_run.head_sha }}\`
          **Built:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          These binaries are built from the latest code and may be unstable.
          For stable releases, use a tagged version (e.g., v2.5.1)." \
            --prerelease \
            dist/*.tar.gz dist/*.zip dist/checksums.txt
