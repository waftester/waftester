name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write

# Prevent parallel release runs - serialize by commit SHA
# First run wins, subsequent runs wait and can skip if release exists
concurrency:
  group: release-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get tag name if present
        id: get_tag
        run: |
          # Check if the commit has a tag
          TAG=$(git describe --tags --exact-match ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "")
          if [ -n "$TAG" ]; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if release already published
        if: steps.get_tag.outputs.is_tag == 'true'
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          # Check if release exists AND has assets (meaning another run already published)
          ASSET_COUNT=$(gh release view "$TAG" --json assets -q '.assets | length' 2>/dev/null || echo "0")
          if [ "$ASSET_COUNT" -gt "0" ]; then
            echo "✅ Release $TAG already published with $ASSET_COUNT assets - skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG not yet published or has no assets - proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify tag is on main branch
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        run: |
          TAG_SHA=${{ github.event.workflow_run.head_sha }}
          
          # Check if this commit exists on main branch
          if ! git branch -r --contains "$TAG_SHA" | grep -q "origin/main"; then
            echo "::error::Tag must be created from main branch. This tag points to a commit not on main."
            echo "Tagged commit: $TAG_SHA"
            echo "Branches containing this commit:"
            git branch -r --contains "$TAG_SHA"
            exit 1
          fi
          
          echo "✅ Tag verified: commit $TAG_SHA is on main branch"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Delete previous dev release
        if: steps.get_tag.outputs.is_tag != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete dev --yes --cleanup-tag 2>/dev/null || true

      - name: Preserve and merge previous release notes
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        id: prev_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          # Fetch previous release notes if they exist
          PREV_NOTES=$(gh release view "$TAG" --json body -q '.body' 2>/dev/null || echo "")
          if [ -n "$PREV_NOTES" ]; then
            echo "Found previous release notes for $TAG"
            echo "$PREV_NOTES" > /tmp/prev_notes.md
            echo "has_prev=true" >> $GITHUB_OUTPUT
          else
            echo "No previous release found for $TAG"
            echo "has_prev=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing release if tag exists
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          gh release delete "$TAG" --yes 2>/dev/null || true

      - name: Run GoReleaser (tagged release)
        if: steps.get_tag.outputs.is_tag == 'true' && steps.check_release.outputs.skip != 'true'
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ steps.get_tag.outputs.tag }}

      - name: Check for tag on commit (dev build guard)
        if: steps.get_tag.outputs.is_tag != 'true'
        id: dev_guard
        run: |
          # Double-check: skip dev build if ANY version tag exists on this commit
          # Handles race condition where tag push event arrives after branch push
          ALL_TAGS=$(git tag --points-at ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "")
          if echo "$ALL_TAGS" | grep -qE '^v[0-9]'; then
            echo "⏭️ Commit has version tag(s): $ALL_TAGS — skipping dev build"
            echo "skip_dev=true" >> $GITHUB_OUTPUT
          else
            echo "No version tags found — proceeding with dev build"
            echo "skip_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Run GoReleaser (dev release)
        if: steps.get_tag.outputs.is_tag != 'true' && steps.dev_guard.outputs.skip_dev != 'true'
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dev release
        if: steps.get_tag.outputs.is_tag != 'true' && steps.dev_guard.outputs.skip_dev != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create dev \
            --title "Development Build (latest)" \
            --notes "⚠️ **Automated development build from main branch**

          **Commit:** \`${{ github.event.workflow_run.head_sha }}\`
          **Built:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          These binaries are built from the latest code and may be unstable.
          For stable releases, use a tagged version (e.g., v2.5.1)." \
            --prerelease \
            dist/*.tar.gz dist/*.zip dist/checksums.txt
